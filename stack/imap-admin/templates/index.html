<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IMAP Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <main class="layout">
      <section class="card topbar">
        <div>
          <h1>Mail Archive Admin</h1>
          <p>
            Roundcube teste: <a href="{{ roundcube_test_url }}" target="_blank" rel="noreferrer">{{ roundcube_test_url }}</a><br />
            Roundcube produção: <a href="{{ roundcube_prod_url }}" target="_blank" rel="noreferrer">{{ roundcube_prod_url }}</a>
          </p>
        </div>
        <div class="actions">
          <form method="post" action="/dovecot/reload"><button type="submit" title="Executa doveadm reload no container do Dovecot">Reload dovecot</button></form>
          <form method="post" action="/logout"><button class="danger" type="submit">Sair</button></form>
        </div>
      </section>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <section class="card">
            <div class="flash-list">
            {% for category, message in messages %}
              <p class="flash {{ category }}">{{ message }}</p>
            {% endfor %}
            </div>
          </section>
        {% endif %}
      {% endwith %}

      <section class="card">
        <h2>Accounts (Dovecot local users)</h2>
        <form method="post" action="/accounts" class="grid">
          <label class="field">Conta local (email)
            <span class="tip" title="Usuário que fará login no Roundcube e no Dovecot">?</span>
            <input name="email" type="email" placeholder="suporte.ti.sorriso@archive.local" required />
          </label>
          <div class="field submit-field">
            <button type="submit" title="Cria Maildir, gera senha forte e escreve no passwd-file do Dovecot">Criar conta local</button>
          </div>
        </form>
        <p class="hint">A senha é gerada aleatoriamente e exibida apenas uma vez.</p>

        {% if not accounts %}
        <p>Nenhuma conta local criada.</p>
        {% else %}
        <table>
          <tr>
            <th>ID</th>
            <th>Conta</th>
            <th>Status</th>
            <th>Sources</th>
            <th>Último reset</th>
            <th>Ações</th>
          </tr>
          {% for a in accounts %}
          <tr>
            <td>{{ a.id }}</td>
            <td>{{ a.email }}</td>
            <td>{{ 'enabled' if a.enabled else 'disabled' }}</td>
            <td>{{ a.source_count }}</td>
            <td>{{ a.last_password_reset_at or '-' }}</td>
            <td class="actions">
              <form method="post" action="/accounts/{{ a.id }}/reset-password"><button type="submit" title="Gera senha aleatória nova e atualiza o Dovecot">Reset senha</button></form>
              <form method="post" action="/accounts/{{ a.id }}/set-password" class="inline" title="Define uma senha escolhida por você para essa conta local">
                <input name="new_password" type="password" placeholder="Nova senha manual (>=12)" required title="Mínimo de 12 caracteres" />
                <button type="submit">Alterar senha</button>
              </form>
              <form method="post" action="/accounts/{{ a.id }}/validate-credentials" class="inline" title="Valida login com doveadm auth test no Dovecot">
                <input name="validate_password" type="password" placeholder="Senha para validar" required title="Senha não é persistida nessa validação" />
                <button type="submit">Validate credentials</button>
              </form>
              <form method="post" action="/accounts/{{ a.id }}/toggle"><button type="submit" title="Desativa/ativa login no Dovecot sem apagar Maildir">{{ 'Desativar' if a.enabled else 'Ativar' }}</button></form>
              <form method="post" action="/accounts/{{ a.id }}/delete" onsubmit="return confirm('Remover conta do painel? Maildir será preservado.');"><button class="danger" type="submit" title="Remove do painel e do bloco managed no passwd-file; não apaga Maildir">Excluir do painel</button></form>
            </td>
          </tr>
          {% endfor %}
        </table>
        {% endif %}
      </section>

      <section class="card">
        <h2>Nova Source IMAP</h2>
        <form method="post" action="/sources" class="grid">
          <label class="field">Conta local destino
            <span class="tip" title="Conta local (Dovecot) que receberá os emails importados">?</span>
            <select name="local_account_id" required>
              <option value="">Selecione uma conta local</option>
              {% for a in accounts %}
              <option value="{{ a.id }}">{{ a.email }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="field">Nome da source
            <span class="tip" title="Nome amigável para identificar esta origem IMAP">?</span>
            <input name="source_name" placeholder="hostgator-principal" required />
          </label>

          <label class="field">Host IMAP origem
            <span class="tip" title="Exemplo: imap.hostgator.com">?</span>
            <input name="host1" placeholder="imap.hostgator.com" required />
          </label>

          <label class="field">Porta origem
            <span class="tip" title="Padrão IMAPS: 993">?</span>
            <input name="port1" type="number" value="993" required />
          </label>

          <label class="field">Segurança origem
            <span class="tip" title="SSL recomendado para conexões de origem IMAP">?</span>
            <select name="security1">
              <option value="ssl" selected>SSL</option>
              <option value="tls">TLS</option>
              <option value="none">NONE</option>
            </select>
          </label>

          <label class="field">Usuário origem
            <span class="tip" title="Geralmente o email completo da conta no provedor antigo">?</span>
            <input name="user1" placeholder="usuario@dominio.com" required />
          </label>

          <label class="field">Senha origem
            <span class="tip" title="Armazenada criptografada com Fernet (MASTER_KEY)">?</span>
            <input name="password1" type="password" placeholder="Senha origem" required />
          </label>

          <label class="field">Include folders (opcional)
            <span class="tip" title="Somente estas pastas serão importadas. Separe por vírgula ou nova linha.">?</span>
            <input name="include_folders" placeholder="INBOX, Sent" />
          </label>

          <label class="field">Exclude regex (opcional)
            <span class="tip" title="Pastas que não devem ser importadas (regex imapsync)">?</span>
            <input name="exclude_folders" placeholder="Spam|Trash" />
          </label>

          <label class="field">Parâmetros extras (opcional)
            <span class="tip" title="Permitidos, exceto opções destrutivas (delete/expunge/deletefolders/fast)">?</span>
            <input name="extra_args" placeholder="--maxsize 5000000" />
          </label>

          <label class="field">Agendamento ativo
            <span class="tip" title="Se marcado, o import roda automaticamente">?</span>
            <label class="inline"><input type="checkbox" name="schedule_enabled" /> Habilitar</label>
          </label>

          <label class="field">Tipo de agendamento
            <span class="tip" title="Intervalo em minutos ou cron">?</span>
            <select name="schedule_mode">
              <option value="interval" selected>Intervalo (minutos)</option>
              <option value="cron">Cron</option>
            </select>
          </label>

          <label class="field">Valor do agendamento
            <span class="tip" title="Intervalo: 360. Cron: 0 */6 * * *">?</span>
            <input name="schedule_value" placeholder="360 ou 0 */6 * * *" value="360" required />
          </label>

          <div class="field submit-field">
            <button type="submit">Salvar source</button>
          </div>
        </form>
      </section>

      <section class="card">
        <h2>Sources</h2>
        {% if not sources %}
        <p>Nenhuma source cadastrada.</p>
        {% else %}
          {% for s in sources %}
          <article class="source-box">
            <header>
              <strong>#{{ s.id }} {{ s.source_name }}</strong>
              <span>{{ s.user1 }}@{{ s.host1 }}:{{ s.port1 }} -> {{ s.local_email }}@{{ 'mailarchive_dovecot' }}:31143</span>
              <span>Status: {{ s.last_status or '-' }}</span>
            </header>
            <form method="post" action="/sources/{{ s.id }}/update" class="grid">
              <label class="field">Nome da source<input name="source_name" value="{{ s.source_name }}" required /></label>
              <label class="field">Host origem<input name="host1" value="{{ s.host1 }}" required /></label>
              <label class="field">Porta origem<input name="port1" type="number" value="{{ s.port1 }}" required /></label>
              <label class="field">Segurança origem
                <select name="security1">
                  <option value="ssl" {{ 'selected' if s.security1 == 'ssl' else '' }}>SSL</option>
                  <option value="tls" {{ 'selected' if s.security1 == 'tls' else '' }}>TLS</option>
                  <option value="none" {{ 'selected' if s.security1 == 'none' else '' }}>NONE</option>
                </select>
              </label>
              <label class="field">Usuário origem<input name="user1" value="{{ s.user1 }}" required /></label>
              <label class="field">Nova senha origem (opcional)<input name="password1" type="password" placeholder="Preencha só se quiser trocar" /></label>
              <label class="field">Include folders<input name="include_folders" value="{{ s.include_folders }}" placeholder="INBOX, Sent" /></label>
              <label class="field">Exclude regex<input name="exclude_folders" value="{{ s.exclude_folders }}" placeholder="Spam|Trash" /></label>
              <label class="field">Parâmetros extras<input name="extra_args" value="{{ s.extra_args }}" placeholder="--maxsize 5000000" /></label>
              <label class="field">Agendamento ativo
                <label class="inline"><input type="checkbox" name="schedule_enabled" {{ 'checked' if s.schedule_enabled else '' }} /> Habilitar</label>
              </label>
              <label class="field">Tipo agendamento
                <select name="schedule_mode">
                  <option value="interval" {{ 'selected' if s.schedule_mode == 'interval' else '' }}>Intervalo (min)</option>
                  <option value="cron" {{ 'selected' if s.schedule_mode == 'cron' else '' }}>Cron</option>
                </select>
              </label>
              <label class="field">Valor agendamento<input name="schedule_value" value="{{ s.schedule_value }}" required /></label>
              <div class="field submit-field"><button type="submit">Salvar alterações</button></div>
            </form>
            <div class="actions">
              <form method="post" action="/sources/{{ s.id }}/import-now"><button type="submit" title="Dispara importação imediata">Import now</button></form>
              <form method="post" action="/sources/{{ s.id }}/toggle-schedule"><button type="submit">{{ 'Desabilitar schedule' if s.schedule_enabled else 'Habilitar schedule' }}</button></form>
              <form method="post" action="/sources/{{ s.id }}/delete" onsubmit="return confirm('Excluir source?');"><button class="danger" type="submit">Excluir source</button></form>
            </div>
          </article>
          {% endfor %}
        {% endif %}
      </section>

      <section class="card">
        <h2>Execuções (imapsync)</h2>
        {% if not runs %}
        <p>Sem execuções ainda.</p>
        {% else %}
        <table>
          <tr>
            <th>Início</th>
            <th>Source</th>
            <th>Conta local</th>
            <th>Status</th>
            <th>Trigger</th>
            <th>Duração</th>
            <th>Exit</th>
            <th>Log</th>
          </tr>
          {% for r in runs %}
          <tr>
            <td>{{ r.started_at }}</td>
            <td>{{ r.source_name }}</td>
            <td>{{ r.local_email }}</td>
            <td>{{ r.status }}</td>
            <td>{{ r.trigger_type }}</td>
            <td>{{ r.duration_seconds if r.duration_seconds is not none else '-' }}</td>
            <td>{{ r.exit_code if r.exit_code is not none else '-' }}</td>
            <td><a href="/runs/{{ r.id }}/log" target="_blank" rel="noreferrer">abrir log</a><br /><code>{{ r.log_path }}</code></td>
          </tr>
          {% endfor %}
        </table>
        {% endif %}
      </section>
    </main>
  </body>
</html>
