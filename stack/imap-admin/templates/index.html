<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mail Archive</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
</head>
<body>
<div class="app">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      <div class="flash-bar {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endwith %}

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-brand">Mail Archive <span>/ admin</span></div>
    <nav class="topbar-nav">
      <a class="nav-link active" href="/">Contas</a>
      <a class="nav-link" href="/logs">Logs</a>
    </nav>
    <div class="topbar-actions">
      <form method="post" action="/dovecot/reload">
        <button class="btn btn-ghost btn-sm" type="submit" title="Executa doveadm reload no container">Reload Dovecot</button>
      </form>
      <form method="post" action="/logout">
        <button class="btn btn-ghost btn-sm" type="submit">Sair</button>
      </form>
    </div>
  </header>

  <main class="main">
    <div class="section-header">
      <span class="section-title">Contas locais</span>
      <button class="btn btn-primary btn-sm" onclick="openModal('modal-new-account')">+ Nova conta</button>
    </div>

    {% if not accounts %}
    <div class="empty-state">Nenhuma conta local criada. Clique em "Nova conta" para começar.</div>
    {% else %}
    <div class="accounts-grid">
      {% for a in accounts %}
      <div class="account-card {{ '' if a.enabled else 'disabled' }}"
           onclick="openAccountModal({{ a.id }})">
        <div class="account-card-email">{{ a.email }}</div>
        <div class="account-card-meta">
          <div class="meta-row"><span>Armazenamento</span><strong>{{ a.maildir_size }}</strong></div>
          <div class="meta-row"><span>Ultimo sync</span><strong>{{ a.last_sync or '-' }}</strong></div>
          <div class="meta-row"><span>Sources</span><strong>{{ a.source_count }}</strong></div>
          <div class="meta-row">
            <span>Status</span>
            <span class="badge {{ 'badge-ok' if a.enabled else 'badge-off' }}">{{ 'ativo' if a.enabled else 'inativo' }}</span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </main>
</div>

<!-- ══════════════════════════════════ MODAL: Nova conta ══ -->
<div class="modal-overlay" id="modal-new-account">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Nova conta local</span>
      <button class="modal-close" onclick="closeModal('modal-new-account')">&times;</button>
    </div>
    <form method="post" action="/accounts">
      <div class="modal-body">
        <div class="field">
          <label class="field-label">Endereço de email</label>
          <input name="email" type="email" placeholder="usuario@archive.local" required autofocus/>
        </div>
        <p style="margin-top:12px;font-size:12px;color:var(--muted)">
          A senha será gerada automaticamente e exibida apenas uma vez.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeModal('modal-new-account')">Cancelar</button>
        <button type="submit" class="btn btn-primary">Criar conta</button>
      </div>
    </form>
  </div>
</div>

<!-- ══════════════════════════════════ MODAL: Conta ══ -->
<div class="modal-overlay" id="modal-account">
  <div class="modal modal-lg">
    <div class="modal-header">
      <span class="modal-title" id="modal-account-title">Conta</span>
      <button class="modal-close" onclick="closeModal('modal-account')">&times;</button>
    </div>
    <div class="modal-body">

      <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab(this,'tab-info')">Informações</button>
        <button class="tab-btn" onclick="switchTab(this,'tab-password')">Senha</button>
        <button class="tab-btn" onclick="switchTab(this,'tab-sources')">Sources</button>
        <button class="tab-btn" onclick="switchTab(this,'tab-danger')">Ações</button>
      </div>

      <!-- Tab: Info -->
      <div class="tab-pane active" id="tab-info">
        <div class="form-grid">
          <div class="field">
            <label class="field-label">Email</label>
            <input id="ai-email" type="text" readonly style="opacity:.6"/>
          </div>
          <div class="field">
            <label class="field-label">Status</label>
            <input id="ai-status" type="text" readonly style="opacity:.6"/>
          </div>
          <div class="field">
            <label class="field-label">Armazenamento</label>
            <input id="ai-size" type="text" readonly style="opacity:.6"/>
          </div>
          <div class="field">
            <label class="field-label">Último sync</label>
            <input id="ai-sync" type="text" readonly style="opacity:.6"/>
          </div>
          <div class="field span2">
            <label class="field-label">Criado em</label>
            <input id="ai-created" type="text" readonly style="opacity:.6"/>
          </div>
        </div>
        <hr class="modal-sep"/>
        <p style="font-size:12px;color:var(--muted)">Validar login no Dovecot:</p>
        <form id="form-validate" method="post" style="margin-top:10px">
          <div style="display:flex;gap:8px">
            <input name="validate_password" type="password" placeholder="Informe a senha para validar" style="flex:1"/>
            <button type="submit" class="btn btn-ghost btn-sm">Validar</button>
          </div>
        </form>
      </div>

      <!-- Tab: Senha -->
      <div class="tab-pane" id="tab-password">
        <div style="display:flex;flex-direction:column;gap:16px">
          <div>
            <p class="divider-label">Resetar senha automaticamente</p>
            <p style="font-size:12px;color:var(--muted);margin-bottom:10px">Gera uma senha aleatória forte. A senha atual deixa de funcionar imediatamente.</p>
            <form id="form-reset-pwd" method="post">
              <button type="submit" class="btn btn-warn btn-sm">Gerar nova senha</button>
            </form>
          </div>
          <hr class="modal-sep"/>
          <div>
            <p class="divider-label">Definir senha manualmente</p>
            <form id="form-set-pwd" method="post">
              <div class="form-grid">
                <div class="field span2">
                  <label class="field-label">Nova senha (mínimo 12 caracteres)</label>
                  <input name="new_password" type="password" placeholder="Nova senha" required minlength="12"/>
                </div>
              </div>
              <div style="margin-top:12px">
                <button type="submit" class="btn btn-primary btn-sm">Salvar senha</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Tab: Sources -->
      <div class="tab-pane" id="tab-sources">
        <div id="sources-list"></div>
        <hr class="modal-sep"/>
        <details class="add-source-details">
          <summary class="btn btn-ghost btn-sm" style="list-style:none;cursor:pointer;display:inline-flex;align-items:center;gap:6px">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Adicionar source
          </summary>
          <div style="margin-top:14px">
            <form id="form-new-source" method="post" action="/sources">
              <input type="hidden" id="ns-account-id" name="local_account_id"/>
              <div class="form-grid">
                <div class="field">
                  <label class="field-label">Nome da source</label>
                  <input name="source_name" placeholder="hostgator-principal" required/>
                </div>
                <div class="field">
                  <label class="field-label">Host IMAP origem</label>
                  <input name="host1" placeholder="mail.servidor.com.br" required/>
                </div>
                <div class="field">
                  <label class="field-label">Porta</label>
                  <input name="port1" type="number" value="993" required/>
                </div>
                <div class="field">
                  <label class="field-label">Segurança</label>
                  <select name="security1">
                    <option value="ssl" selected>SSL</option>
                    <option value="tls">TLS</option>
                    <option value="none">Nenhuma</option>
                  </select>
                </div>
                <div class="field">
                  <label class="field-label">Usuário origem</label>
                  <input name="user1" placeholder="usuario@dominio.com" required/>
                </div>
                <div class="field">
                  <label class="field-label">Senha origem</label>
                  <input name="password1" type="password" placeholder="Senha" required/>
                </div>
                <div class="field span2">
                  <label class="field-label">Include folders (vírgula ou linha)</label>
                  <input name="include_folders" placeholder="INBOX, Sent"/>
                </div>
                <div class="field span2">
                  <label class="field-label">Exclude regex</label>
                  <input name="exclude_folders" placeholder="Spam|Trash"/>
                </div>
                <div class="field span2">
                  <label class="field-label">Parâmetros extras</label>
                  <input name="extra_args" placeholder="--maxsize 5000000"/>
                </div>
                <div class="field span2">
                  <label class="checkbox-row">
                    <input type="checkbox" name="schedule_enabled"/> Habilitar agendamento
                  </label>
                </div>
                <div class="field">
                  <label class="field-label">Tipo de agendamento</label>
                  <select name="schedule_mode">
                    <option value="interval" selected>Intervalo (minutos)</option>
                    <option value="cron">Cron</option>
                  </select>
                </div>
                <div class="field">
                  <label class="field-label">Valor</label>
                  <input name="schedule_value" value="360" placeholder="360 ou 0 */6 * * *" required/>
                </div>
              </div>
              <div style="margin-top:14px">
                <button type="submit" class="btn btn-primary btn-sm">Salvar source</button>
              </div>
            </form>
          </div>
        </details>
      </div>

      <!-- Tab: Ações -->
      <div class="tab-pane" id="tab-danger">
        <div style="display:flex;flex-direction:column;gap:14px">
          <div style="background:var(--surface2);border-radius:var(--radius);padding:14px">
            <p style="font-size:13px;font-weight:500;margin-bottom:6px;color:var(--text)">Desativar / Ativar conta</p>
            <p style="font-size:12px;color:var(--muted);margin-bottom:10px">Bloqueia ou libera o login no Dovecot. O Maildir e os dados ficam preservados.</p>
            <form id="form-toggle" method="post">
              <button type="submit" id="btn-toggle" class="btn btn-warn btn-sm">Desativar</button>
            </form>
          </div>
          <div style="background:rgba(192,57,43,.08);border:1px solid rgba(192,57,43,.2);border-radius:var(--radius);padding:14px">
            <p style="font-size:13px;font-weight:500;margin-bottom:6px;color:#e74c3c">Remover conta do painel</p>
            <p style="font-size:12px;color:var(--muted);margin-bottom:10px">Remove o acesso e as sources do banco. O Maildir no servidor não é apagado.</p>
            <form id="form-delete" method="post" onsubmit="return confirm('Remover conta do painel? O Maildir será preservado.')">
              <button type="submit" class="btn btn-danger btn-sm">Remover do painel</button>
            </form>
          </div>
        </div>
      </div>

    </div><!-- /modal-body -->
  </div>
</div>

<!-- ══════════════════════════════════ MODAL: Editar source ══ -->
<div class="modal-overlay" id="modal-edit-source">
  <div class="modal modal-lg">
    <div class="modal-header">
      <span class="modal-title" id="modal-source-title">Editar source</span>
      <button class="modal-close" onclick="closeModal('modal-edit-source')">&times;</button>
    </div>
    <form id="form-edit-source" method="post">
      <div class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label class="field-label">Nome da source</label>
            <input id="es-name" name="source_name" required/>
          </div>
          <div class="field">
            <label class="field-label">Host IMAP origem</label>
            <input id="es-host" name="host1" required/>
          </div>
          <div class="field">
            <label class="field-label">Porta</label>
            <input id="es-port" name="port1" type="number" required/>
          </div>
          <div class="field">
            <label class="field-label">Segurança</label>
            <select id="es-sec" name="security1">
              <option value="ssl">SSL</option>
              <option value="tls">TLS</option>
              <option value="none">Nenhuma</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Usuário origem</label>
            <input id="es-user" name="user1" required/>
          </div>
          <div class="field">
            <label class="field-label">Nova senha (vazio = manter)</label>
            <input id="es-pass" name="password1" type="password" placeholder="Preencha só se quiser trocar"/>
          </div>
          <div class="field span2">
            <label class="field-label">Include folders</label>
            <input id="es-inc" name="include_folders" placeholder="INBOX, Sent"/>
          </div>
          <div class="field span2">
            <label class="field-label">Exclude regex</label>
            <input id="es-exc" name="exclude_folders" placeholder="Spam|Trash"/>
          </div>
          <div class="field span2">
            <label class="field-label">Parâmetros extras</label>
            <input id="es-extra" name="extra_args" placeholder="--maxsize 5000000"/>
          </div>
          <div class="field span2">
            <label class="checkbox-row">
              <input id="es-sched" type="checkbox" name="schedule_enabled"/> Habilitar agendamento
            </label>
          </div>
          <div class="field">
            <label class="field-label">Tipo</label>
            <select id="es-smode" name="schedule_mode">
              <option value="interval">Intervalo (minutos)</option>
              <option value="cron">Cron</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Valor</label>
            <input id="es-sval" name="schedule_value" required/>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeModal('modal-edit-source')">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar alterações</button>
      </div>
    </form>
  </div>
</div>

<!-- ══════════════════════════════════ DATA ══ -->
<script>
// All data injected safely via JSON — never inside onclick attributes
const ACCOUNTS = {{ accounts|tojson }};
const SOURCES  = {{ sources|tojson }};
</script>

<!-- ══════════════════════════════════ JS ══ -->
<script>
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
}
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(overlay.id); });
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape')
    document.querySelectorAll('.modal-overlay.open').forEach(o => closeModal(o.id));
});

function switchTab(btn, paneId) {
  const modal = btn.closest('.modal');
  modal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  modal.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(paneId).classList.add('active');
}

function openAccountModal(accountId) {
  const account = ACCOUNTS.find(a => a.id === accountId);
  if (!account) return;
  const sources = SOURCES.filter(s => s.local_account_id === accountId);

  // Reset tabs
  document.querySelectorAll('#modal-account .tab-btn').forEach((b, i) => b.classList.toggle('active', i === 0));
  document.querySelectorAll('#modal-account .tab-pane').forEach((p, i) => p.classList.toggle('active', i === 0));

  // Info
  document.getElementById('modal-account-title').textContent = account.email;
  document.getElementById('ai-email').value   = account.email;
  document.getElementById('ai-status').value  = account.enabled ? 'Ativo' : 'Inativo';
  document.getElementById('ai-size').value    = account.maildir_size || '-';
  document.getElementById('ai-sync').value    = account.last_sync   || '-';
  document.getElementById('ai-created').value = account.created_at  || '-';
  document.getElementById('form-validate').action = `/accounts/${accountId}/validate-credentials`;

  // Password
  document.getElementById('form-reset-pwd').action = `/accounts/${accountId}/reset-password`;
  document.getElementById('form-set-pwd').action   = `/accounts/${accountId}/set-password`;

  // Sources
  document.getElementById('ns-account-id').value = accountId;
  renderSources(sources);

  // Actions
  document.getElementById('form-toggle').action = `/accounts/${accountId}/toggle`;
  document.getElementById('btn-toggle').textContent = account.enabled ? 'Desativar conta' : 'Ativar conta';
  document.getElementById('form-delete').action = `/accounts/${accountId}/delete`;

  openModal('modal-account');
}

function renderSources(sources) {
  const container = document.getElementById('sources-list');
  if (!sources || sources.length === 0) {
    container.innerHTML = '<p style="font-size:12px;color:var(--muted);margin-bottom:12px">Nenhuma source cadastrada.</p>';
    return;
  }
  container.innerHTML = sources.map(s => {
    const statusClass = s.last_status === 'success' ? 'badge-success'
                      : s.last_status === 'running'  ? 'badge-running'
                      : s.last_status               ? 'badge-fail'
                      :                               'badge-neutral';
    const statusLabel = s.last_status || 'sem execução';
    const schedInfo = s.schedule_enabled
      ? `agendado (${escHtml(s.schedule_mode)}: ${escHtml(String(s.schedule_value))})`
      : 'sem agendamento';
    return `
    <div class="source-row">
      <div class="source-info">
        <strong>${escHtml(s.source_name)}</strong>
        <span>${escHtml(s.user1)} @ ${escHtml(s.host1)}:${s.port1}</span>
        <span>${schedInfo} &mdash; último sync: ${s.last_sync_at || '-'}</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
        <span class="badge ${statusClass}">${escHtml(statusLabel)}</span>
        <div class="source-actions">
          <form method="post" action="/sources/${s.id}/import-now" style="display:inline">
            <button class="btn btn-primary btn-sm" type="submit">Importar</button>
          </form>
          <button class="btn btn-ghost btn-sm" type="button"
                  onclick="openEditSource(${s.id})">Editar</button>
          <form method="post" action="/sources/${s.id}/delete"
                onsubmit="return confirm('Excluir source?')" style="display:inline">
            <button class="btn btn-danger btn-sm" type="submit">Excluir</button>
          </form>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openEditSource(sourceId) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  document.getElementById('modal-source-title').textContent = `Editar source: ${s.source_name}`;
  document.getElementById('form-edit-source').action = `/sources/${s.id}/update`;
  document.getElementById('es-name').value    = s.source_name   || '';
  document.getElementById('es-host').value    = s.host1         || '';
  document.getElementById('es-port').value    = s.port1         || 993;
  document.getElementById('es-sec').value     = s.security1     || 'ssl';
  document.getElementById('es-user').value    = s.user1         || '';
  document.getElementById('es-pass').value    = '';
  document.getElementById('es-inc').value     = s.include_folders || '';
  document.getElementById('es-exc').value     = s.exclude_folders || '';
  document.getElementById('es-extra').value   = s.extra_args    || '';
  document.getElementById('es-sched').checked = !!s.schedule_enabled;
  document.getElementById('es-smode').value   = s.schedule_mode || 'interval';
  document.getElementById('es-sval').value    = s.schedule_value || '360';
  openModal('modal-edit-source');
}

function escHtml(str) {
  return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
